server {
    listen 80;
    server_name palimpsestus.art www.palimpsestus.art;

    root /var/www/production;
    index index.html;

    # ── Font files: immutable, 1 year cache ──
    # Content changes → new woff2 generated → browser fetches fresh.
    # Old visitors keep cached version until next deploy.
    location ~* \.woff2$ {
        expires 365d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
    }

    # ── Hashed assets (CSS/JS): 1 year cache ──
    # Astro generates content-hashed filenames, safe to cache forever.
    location /_astro/ {
        expires 365d;
        add_header Cache-Control "public, immutable";
    }

    # ── Images and static assets ──
    location ~* \.(jpg|jpeg|png|gif|webp|svg|ico)$ {
        expires 30d;
        add_header Cache-Control "public";
    }

    # ── HTML pages: short cache, revalidate on each visit ──
    # Ensures readers always see the latest content.
    location / {
        try_files $uri $uri/ $uri/index.html =404;
        add_header Cache-Control "no-cache";
    }

    # ── Security headers ──
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ── Gzip for text assets ──
    gzip on;
    gzip_types text/html text/css application/javascript application/json;
    gzip_min_length 256;

    # Error pages
    error_page 404 /404.html;
}
