# ============================================================
# Redirect HTTP → HTTPS (all domains)
# ============================================================
server {
    listen 80;
    server_name palimpsestus.art www.palimpsestus.art stage.palimpsestus.art;
    return 301 https://$host$request_uri;
}

# ============================================================
# Redirect www → bare domain
# ============================================================
server {
    listen 443 ssl;
    http2 on;
    server_name www.palimpsestus.art;

    ssl_certificate     /etc/nginx/ssl/production/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/production/privkey.pem;

    return 301 https://palimpsestus.art$request_uri;
}

# ============================================================
# Production: palimpsestus.art
# ============================================================
server {
    listen 443 ssl;
    http2 on;
    server_name palimpsestus.art;

    # --- SSL (Tencent Cloud certificate) ---
    ssl_certificate     /etc/nginx/ssl/production/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/production/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers on;
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 10m;

    # --- Security Headers ---
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' fonts.googleapis.com cdn.jsdelivr.net; font-src 'self' fonts.gstatic.com cdn.jsdelivr.net; img-src 'self' data: licensebuttons.net i.creativecommons.org;" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # --- Rate Limiting ---
    limit_req zone=general burst=10 nodelay;

    # --- AI Bot Blocking ---
    if ($is_ai_bot) {
        return 403;
    }

    # --- Static Files ---
    root /var/www/production;
    index index.html;

    # Clean URLs: /01/00/ → /01/00/index.html
    location / {
        try_files $uri $uri/ $uri/index.html =404;
    }

    # Cache static assets
    location ~* \.(css|js|woff2|woff|ttf|svg|png|jpg|jpeg|gif|ico)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Font files: allow cross-origin (for CDN if needed later)
    location /fonts/ {
        add_header Access-Control-Allow-Origin "*";
        expires 365d;
    }

    # Custom 404
    error_page 404 /404.html;
}

# ============================================================
# Staging: stage.palimpsestus.art
# ============================================================
server {
    listen 443 ssl;
    http2 on;
    server_name stage.palimpsestus.art;

    # --- SSL (Tencent Cloud certificate for staging) ---
    ssl_certificate     /etc/nginx/ssl/staging/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/staging/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;

    # --- Basic Auth ---
    auth_basic "Preview Access";
    auth_basic_user_file /etc/nginx/htpasswd;

    # --- Rate Limiting (stricter for staging) ---
    limit_req zone=general burst=5 nodelay;

    # --- AI Bot Blocking ---
    if ($is_ai_bot) {
        return 403;
    }

    # --- Security Headers ---
    add_header X-Frame-Options "DENY" always;
    add_header X-Robots-Tag "noindex, nofollow" always;

    # --- Static Files ---
    root /var/www/staging;
    index index.html;

    location / {
        try_files $uri $uri/ $uri/index.html =404;
    }

    location ~* \.(css|js|woff2|woff|ttf|svg|png|jpg|jpeg|gif|ico)$ {
        expires 7d;
    }

    location /fonts/ {
        add_header Access-Control-Allow-Origin "*";
    }

    error_page 404 /404.html;
}
