@tailwind base;
@tailwind components;
@tailwind utilities;

/* ============================================================
   Fonts — fully self-hosted, no external CDN
   ============================================================
   SiteSerif: build-time subsets from NotoSerifCJKsc OTF source files.
   Python scans all content, extracts unique chars, generates woff2.
   All characters (common + rare, CJK + Latin) from the same source,
   ensuring pixel-perfect visual consistency across all platforms.
   ============================================================ */

@font-face {
  font-family: 'SiteSerif';
  src: url('/fonts/SiteSerif-300.woff2') format('woff2');
  font-weight: 300;
  font-style: normal;
  font-display: swap;
}
@font-face {
  font-family: 'SiteSerif';
  src: url('/fonts/SiteSerif-400.woff2') format('woff2');
  font-weight: 400;
  font-style: normal;
  font-display: swap;
}
@font-face {
  font-family: 'SiteSerif';
  src: url('/fonts/SiteSerif-600.woff2') format('woff2');
  font-weight: 600;
  font-style: normal;
  font-display: swap;
}
@font-face {
  font-family: 'SiteSerif';
  src: url('/fonts/SiteSerif-700.woff2') format('woff2');
  font-weight: 700;
  font-style: normal;
  font-display: swap;
}

/* Nüshu serif — official woff2 from nushu-script/Nyushu v1.0022
   55KB, includes 396 nüshu + 1765 hanzi double-encoded glyphs.
   Two declarations:
   1. unicode-range scoped: catches direct nüshu chars in body text
   2. Unscoped: used by .nushu class for hanzi→nüshu rendering */
@font-face {
  font-family: 'NushuSerif-Fallback';
  src: url('/fonts/NushuSerif.woff2') format('woff2');
  font-weight: 400;
  font-style: normal;
  font-display: swap;
  unicode-range: U+1B170-1B2FF, U+16FE1;
}
@font-face {
  font-family: 'NushuSerif';
  src: url('/fonts/NushuSerif.woff2') format('woff2');
  font-weight: 400;
  font-style: normal;
  font-display: swap;
}

/* ============================================================
   Theme Variables
   ============================================================ */

:root {
  --bg: #F4F1EA;
  --bg-surface: #EDE9E0;
  --text: #2C2C2C;
  --text-muted: #6B6560;
  --border: #D4CFC6;
  --accent: #8B4513;
  --link: #8B4513;
  --sidenote-hint: rgba(139, 69, 19, 0.3);
  --sidenote-active: #8B4513;
  --sidenote-bg: #EDE9E0;
  --sidenote-border: #8B4513;
  --selection: rgba(139, 69, 19, 0.15);
  --font-size: 1.125rem;
  --font-weight: 400;
  --font-serif: 'SiteSerif', 'NushuSerif-Fallback', serif;
  --font-sans: system-ui, -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Microsoft YaHei', sans-serif;
  --line-height: 1.9;
  --content-max-width: 42rem;
  --sidenote-width: 14rem;
  --sidenote-gap: 2rem;
  --drawer-width: 18rem;
  --progress-height: 2px;
  --transition-color: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
}

[data-theme='white'] {
  --bg: #FAFAFA; --bg-surface: #F0F0F0; --text: #2C2C2C; --text-muted: #666666;
  --border: #E0E0E0; --accent: #8B4513; --link: #8B4513;
  --sidenote-hint: rgba(139,69,19,.3); --sidenote-active: #8B4513;
  --sidenote-bg: #F0F0F0; --sidenote-border: #8B4513; --selection: rgba(139,69,19,.15);
}

[data-theme='dark'] {
  --bg: #1A1A1A; --bg-surface: #242424; --text: #D4CFC6; --text-muted: #8A8580;
  --border: #3A3A3A; --accent: #C4875B; --link: #C4875B;
  --sidenote-hint: rgba(196,135,91,.35); --sidenote-active: #C4875B;
  --sidenote-bg: #242424; --sidenote-border: #C4875B; --selection: rgba(196,135,91,.2);
}

[data-fontsize='small']  { --font-size: 1rem; }
[data-fontsize='medium'] { --font-size: 1.125rem; }
[data-fontsize='large']  { --font-size: 1.25rem; }

[data-fontweight='light']   { --font-weight: 300; }
[data-fontweight='regular'] { --font-weight: 400; }

/* ============================================================
   Base — serif everywhere (NYT-style)
   ============================================================ */

html { scroll-behavior: smooth; }

body {
  background-color: var(--bg); color: var(--text);
  font-family: var(--font-serif); font-size: var(--font-size);
  font-weight: var(--font-weight);
  line-height: var(--line-height); transition: var(--transition-color);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
}

::selection { background: var(--selection); color: var(--text); }

#reading-progress {
  position: fixed; top: 0; left: 0; height: var(--progress-height);
  background: var(--accent); z-index: 100; transition: width 0.1s linear; pointer-events: none;
}

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* ============================================================
   Functional UI — sans-serif (settings, footer meta)
   ============================================================ */

#settings-panel,
#settings-toggle,
.func-ui {
  font-family: var(--font-sans);
}

/* ============================================================
   Prose — inherits serif from body
   ============================================================ */

.prose {
  --tw-prose-body: var(--text); --tw-prose-headings: var(--text);
  --tw-prose-lead: var(--text-muted); --tw-prose-links: var(--link);
  --tw-prose-bold: var(--text); --tw-prose-counters: var(--text-muted);
  --tw-prose-bullets: var(--border); --tw-prose-hr: var(--border);
  --tw-prose-quotes: var(--text-muted); --tw-prose-quote-borders: var(--accent);
  --tw-prose-captions: var(--text-muted); --tw-prose-code: var(--text);
  --tw-prose-pre-code: var(--text); --tw-prose-pre-bg: var(--bg-surface);
  --tw-prose-th-borders: var(--border); --tw-prose-td-borders: var(--border);
  font-size: var(--font-size); font-family: var(--font-serif);
  max-width: 100%; line-height: var(--line-height);
}

.prose p { text-indent: 2em; margin-top: 0.8em; margin-bottom: 0.8em; }
.prose h1, .prose h2, .prose h3 { text-indent: 0; font-weight: 600; }
.prose blockquote { border-left-width: 2px; font-style: normal; }
.prose code { background: var(--bg-surface); padding: 0.15em 0.35em; border-radius: 3px; font-size: 0.875em; }
.prose pre { background: var(--bg-surface) !important; border: 1px solid var(--border); }
.prose a { text-decoration-thickness: 1px; text-underline-offset: 2px; }
.prose a:hover { color: var(--accent); }
.prose hr { border-color: var(--border); }

/* ============================================================
   Article Layout (sidenotes)
   ============================================================ */

.article-layout { max-width: var(--content-max-width); margin-left: auto; margin-right: auto; }
@media (min-width: 1200px) {
  .article-layout {
    max-width: calc(var(--content-max-width) + var(--sidenote-gap) + var(--sidenote-width));
    padding-right: calc(var(--sidenote-gap) + var(--sidenote-width));
  }
}

.sidenote-trigger {
  cursor: pointer; text-decoration: underline; text-decoration-style: dashed;
  text-decoration-color: var(--sidenote-hint); text-underline-offset: 3px;
  text-decoration-thickness: 1px; transition: color 0.2s ease, text-decoration-color 0.2s ease;
}
.sidenote-trigger:hover, .sidenote-trigger.active {
  color: var(--sidenote-active); text-decoration-color: var(--sidenote-active);
  text-decoration-style: solid;
}

.sidenote-content {
  display: none; margin: 0.5em 0; padding: 0.75em 1em;
  background: var(--sidenote-bg); border-left: 2px solid var(--sidenote-border);
  font-size: 0.9em; color: var(--text-muted); line-height: 1.6;
  border-radius: 0 4px 4px 0; transition: var(--transition-color); text-indent: 0;
}
.sidenote-content.open { display: block; }
@media (min-width: 1200px) {
  .sidenote-content.open {
    float: right; clear: right; width: var(--sidenote-width);
    margin-right: calc(-1 * (var(--sidenote-gap) + var(--sidenote-width)));
    margin-top: 0; margin-bottom: 0.75em; margin-left: 0;
    padding: 0 0 0 0.75em; background: transparent;
    border-left: 1px solid var(--border); border-radius: 0; font-size: 0.85em;
  }
}

/* ============================================================
   Chapter Header — serif with weight/size hierarchy
   ============================================================ */

.chapter-header { text-align: center; padding: 2rem 0 0; max-width: var(--content-max-width); }
.chapter-label {
  font-size: 0.8rem; font-weight: 400; letter-spacing: 0.3em;
  color: var(--text-muted); margin-bottom: 0.75rem;
}
.chapter-title {
  font-size: 1.8rem; font-weight: 600; letter-spacing: 0.15em;
  color: var(--text); margin-bottom: 0.25rem;
}
.chapter-subtitle {
  font-size: 0.85rem; letter-spacing: 0.2em; color: var(--text-muted);
  font-style: italic; margin-top: 0.75rem; padding-bottom: 0.5rem;
}
.chapter-divider {
  width: 8rem; margin: 2rem auto 2.5rem;
  border: none; border-top: 1px solid var(--border); position: relative;
}
.chapter-divider::after {
  content: '·'; position: absolute; top: -0.6em; left: 50%;
  transform: translateX(-50%); background: var(--bg);
  padding: 0 0.75em; color: var(--text-muted); font-size: 1rem;
}
.chapter-cover { max-width: 80%; margin: 2rem auto; border-radius: 4px; display: block; }

/* ============================================================
   Subtitle Segments
   ============================================================ */

.subtitle-segments { display: inline-flex; gap: 0; justify-content: center; }
.subtitle-segment-spacer { display: inline-block; width: 0.1em; }
.subtitle-segment {
  position: relative; cursor: default;
  border-bottom: 1px dashed var(--text-muted); padding-bottom: 2px;
  transition: border-color 0.2s ease, color 0.2s ease;
}
.subtitle-segment:hover {
  border-bottom-style: solid; border-color: var(--accent); color: var(--accent);
}
.subtitle-segment-tooltip {
  position: absolute; top: calc(100% + 6px); left: 50%; transform: translateX(-50%);
  white-space: nowrap; font-size: 0.7rem; color: var(--accent);
  letter-spacing: 0.05em; font-style: normal; opacity: 0;
  pointer-events: none; transition: opacity 0.2s ease;
}
.subtitle-segment:hover .subtitle-segment-tooltip { opacity: 1; }

/* ============================================================
   Chapter TOC — serif, lighter weight for hierarchy
   ============================================================ */

.chapter-toc-wrapper { border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 2rem; }
.chapter-toc { display: flex; flex-direction: column; }
.chapter-toc-item {
  display: flex; align-items: center; padding: 0.4rem 0;
  color: var(--text); font-size: 0.95rem;
  transition: opacity 0.15s; text-decoration: none;
}
.chapter-toc-item:hover { opacity: 0.6; }
.chapter-toc-item[data-depth='2'],
.chapter-toc-item[data-depth='3'] { font-size: 0.875rem; }
.chapter-toc-dot {
  width: 1rem; flex-shrink: 0; text-align: center;
  opacity: 0.3; color: var(--text-muted); font-size: 0.8rem; margin-right: 0.25rem;
}

/* ============================================================
   Drawer Overlay
   ============================================================ */

#drawer-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.4);
  z-index: 40; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
}
#drawer-overlay.active { opacity: 1; pointer-events: auto; }

/* ============================================================
   Reader Letter — serif
   ============================================================ */

.reader-letter {
  margin: 2em 0; padding: 1.5em 2em;
  background: var(--bg-surface); border-radius: 4px;
  font-family: var(--font-serif);
  font-size: 0.95em; line-height: 1.8;
  position: relative; transition: var(--transition-color);
}
.reader-letter::before {
  content: '\2709\FE0E'; position: absolute; top: 0.75em; right: 1em;
  font-size: 1.2em; opacity: 0.3;
}
.reader-letter-meta {
  margin-top: 1em; text-align: right;
  color: var(--text-muted); font-size: 0.85em;
}

/* ============================================================
   Nüshu — renders hanzi as nüshu glyphs via double-encoding
   Usage in MDX: <Nushu>女人水火</Nushu>
   Copy-paste gives back hanzi. Pure CSS magic.
   ============================================================ */

.nushu {
  font-family: 'NushuSerif', serif;
  /* Nüshu is traditionally written top-to-bottom, but in inline
     horizontal context we just apply the font. The 1.0022 version
     is pre-scaled 1.333x for hanzi mixed typesetting. */
}

/* Enable OpenType contextual alternates by default */
.nushu { font-feature-settings: 'calt' 1; }

/* Optional: expose stylistic sets via utility classes
   Usage: <Nushu class="nushu-original">text</Nushu> */
.nushu-original { font-feature-settings: 'calt' 1, 'ss01' 1; }
.nushu-alt      { font-feature-settings: 'calt' 1, 'ss03' 1; }

/* ============================================================
   Transitions
   ============================================================ */

@keyframes fade-in {
  from { opacity: 0; transform: translateY(4px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes fade-out {
  from { opacity: 1; }
  to   { opacity: 0; transform: translateY(-4px); }
}
::view-transition-old(main-content) { animation: fade-out 0.15s ease-out forwards; }
::view-transition-new(main-content) { animation: fade-in 0.15s ease-in forwards; }
