---
import { site, ui } from '@/config/site';
import type { TreeNode } from '@/lib/tree';

interface Props {
  chapters: TreeNode[];
}

const { chapters } = Astro.props;

// Serialize tree with breadcrumb for display names
const treeData = JSON.stringify(chapters.map(function ser(n: TreeNode): any {
  return {
    id: n.id, title: n.title, url: n.url, depth: n.depth,
    breadcrumb: n.breadcrumb,
    hasChildren: n.hasChildren, isChapter: n.isChapter,
    children: n.children.map(ser),
  };
}));
---

<button id="drawer-toggle"
  class="fixed top-4 left-4 z-50 w-10 h-10 rounded-full flex items-center justify-center transition-all duration-200 hover:scale-110"
  style="background: var(--bg-surface); color: var(--text-muted); border: 1px solid var(--border);"
  aria-label={ui.nav.openDrawer} title={ui.nav.drawerTitle}>
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
  </svg>
</button>

<div id="drawer-overlay"></div>

<aside id="drawer-panel"
  class="fixed top-0 left-0 h-full z-50 overflow-y-auto transform -translate-x-full transition-transform duration-300 ease-out"
  style={`width: var(--drawer-width); background: var(--bg); border-right: 1px solid var(--border);`}>
  <div class="p-6 pt-8">
    <a href="/" class="block mb-6">
      <h2 class="text-lg font-semibold" style="color: var(--text);">{site.name}</h2>
      <span class="text-xs tracking-widest" style="color: var(--text-muted);">{site.nameEn.toUpperCase()}</span>
    </a>
    <hr style="border-color: var(--border);" class="mb-4" />
    <nav id="drawer-nav"></nav>
  </div>
</aside>

<script is:inline define:vars={{ treeData }}>
  window.__palimpsestusTree = treeData;
</script>

<script>
  function urlToId(pathname: string): string {
    const parts = pathname.replace(/^\/|\/$/g, '').split('/');
    if (parts.length < 2) return '';
    return `${parts[0]}/${parts.slice(1).join('-')}`;
  }

  function isAncestorOf(ancestorId: string, targetId: string): boolean {
    if (!ancestorId || !targetId) return false;
    const a = ancestorId.replace(/^[^/]+\//, '');
    const t = targetId.replace(/^[^/]+\//, '');
    return t.startsWith(a + '-');
  }

  function displayName(node: any): string {
    return node.breadcrumb?.length ? node.breadcrumb[node.breadcrumb.length - 1] : node.title;
  }

  // ── Drawer open/close: always live DOM queries ──

  function isDrawerOpen(): boolean {
    return !document.getElementById('drawer-panel')?.classList.contains('-translate-x-full');
  }
  function openDrawer() {
    document.getElementById('drawer-panel')?.classList.remove('-translate-x-full');
    document.getElementById('drawer-overlay')?.classList.add('active');
  }
  function closeDrawer() {
    document.getElementById('drawer-panel')?.classList.add('-translate-x-full');
    document.getElementById('drawer-overlay')?.classList.remove('active');
    (document.activeElement as HTMLElement)?.blur();
  }

  // ── Event delegation: bound ONCE on document, survives all View Transition DOM swaps ──
  // Guard: if script re-runs after full page reload, don't add duplicate listeners
  if (!(window as any).__drawerDelegated) {
    (window as any).__drawerDelegated = true;

    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;

      // Toggle button (use closest() to handle clicks on SVG children)
      if (target.closest('#drawer-toggle')) {
        isDrawerOpen() ? closeDrawer() : openDrawer();
        return;
      }

      // Overlay click
      if (target.closest('#drawer-overlay')) {
        closeDrawer();
        return;
      }

      // Click outside drawer panel while open → close
      if (isDrawerOpen() && !target.closest('#drawer-panel')) {
        closeDrawer();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isDrawerOpen()) {
        closeDrawer();
      }
    });
  }

  // ── Nav tree rendering (page-specific, rebuilt after each navigation) ──

  function buildDrawerNav() {
    const nav = document.getElementById('drawer-nav');
    if (!nav) return;

    const raw = (window as any).__palimpsestusTree;
    if (!raw) return;
    const chapters = JSON.parse(raw);
    const currentId = urlToId(window.location.pathname);

    nav.innerHTML = '';

    function renderNode(node: any, container: HTMLElement) {
      const isActive = node.id === currentId;
      const isAncestor = isAncestorOf(node.id, currentId);

      const row = document.createElement('div');
      row.style.cssText = 'display:flex; align-items:center;';

      const iconCol = document.createElement('span');
      iconCol.style.cssText = 'width:1rem; flex-shrink:0; display:flex; align-items:center; justify-content:center;';

      if (node.hasChildren) {
        const arrow = document.createElement('span');
        arrow.style.cssText = `
          display:inline-block; width:0; height:0;
          border-top: 4px solid transparent;
          border-bottom: 4px solid transparent;
          border-left: 5px solid var(--text-muted);
          transition: transform 0.2s ease;
          cursor: pointer;
        `;
        iconCol.appendChild(arrow);
        iconCol.style.cursor = 'pointer';

        let isOpen = isActive || isAncestor;
        if (isOpen) arrow.style.transform = 'rotate(90deg)';

        const childBox = document.createElement('div');
        childBox.style.cssText = `display:grid; grid-template-rows:${isOpen ? '1fr' : '0fr'}; transition:grid-template-rows 0.3s ease;`;
        const childInner = document.createElement('div');
        childInner.style.cssText = 'overflow:hidden; padding-left:1rem;';
        childBox.appendChild(childInner);

        iconCol.addEventListener('click', (e) => {
          e.stopPropagation();
          isOpen = !isOpen;
          childBox.style.gridTemplateRows = isOpen ? '1fr' : '0fr';
          arrow.style.transform = isOpen ? 'rotate(90deg)' : '';
        });

        row.appendChild(iconCol);

        const link = document.createElement('a');
        link.href = node.url;
        link.textContent = displayName(node);
        link.style.cssText = `display:block; padding:0.3rem 0; font-size:0.875rem; flex:1; min-width:0; transition:opacity 0.15s; ${isActive ? 'font-weight:600; color:var(--accent);' : 'color:var(--text);'}`;
        row.appendChild(link);
        container.appendChild(row);

        node.children.forEach((child: any) => renderNode(child, childInner));
        container.appendChild(childBox);
      } else {
        row.appendChild(iconCol);

        const link = document.createElement('a');
        link.href = node.url;
        link.textContent = displayName(node);
        link.style.cssText = `display:block; padding:0.3rem 0; font-size:0.8125rem; flex:1; min-width:0; transition:opacity 0.15s; ${isActive ? 'font-weight:600; color:var(--accent);' : 'color:var(--text); opacity:0.85;'}`;
        row.appendChild(link);
        container.appendChild(row);
      }
    }

    chapters.forEach((ch: any) => renderNode(ch, nav));
  }

  buildDrawerNav();
  document.addEventListener('astro:after-swap', buildDrawerNav);
  document.addEventListener('astro:before-swap', closeDrawer);
</script>
