---
import { ui } from '@/config/site';

const { themes, fontSizes, fontWeights, sidenotes } = ui.settings;
---

<button id="settings-toggle"
  class="fixed bottom-6 right-6 z-30 w-10 h-10 rounded-full flex items-center justify-center transition-all duration-200 hover:scale-110"
  style="background: var(--bg-surface); color: var(--text-muted); border: 1px solid var(--border);"
  aria-label={ui.settings.label} title={ui.settings.label}>
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
  </svg>
</button>

<div id="settings-panel" class="fixed bottom-20 right-6 z-30 rounded-lg p-5 w-64 hidden"
  style="background: var(--bg-surface); border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
  <div class="space-y-5">

    {/* ── Theme ── */}
    <div>
      <label class="block text-xs mb-2 tracking-wider" style="color: var(--text-muted);">{ui.settings.bgLabel}</label>
      <div class="flex gap-2">
        {Object.entries(themes).map(([key, label]) => (
          <button data-set-theme={key}
            class="theme-btn flex-1 py-1.5 rounded text-xs transition-all"
            style={`border: 2px solid transparent; ${
              key === 'paper' ? 'background:#F4F1EA;color:#2C2C2C;' :
              key === 'white' ? 'background:#FAFAFA;color:#2C2C2C;' :
              'background:#1A1A1A;color:#D4CFC6;'
            }`}>
            {label}
          </button>
        ))}
      </div>
    </div>

    {/* ── Font size ── */}
    <div>
      <label class="block text-xs mb-2 tracking-wider" style="color: var(--text-muted);">{ui.settings.fontSizeLabel}</label>
      <div class="flex gap-2">
        {Object.entries(fontSizes).map(([key, label]) => (
          <button data-set-fontsize={key}
            class="fontsize-btn flex-1 py-1.5 rounded text-xs transition-all"
            style="border: 1px solid var(--border);">
            {label}
          </button>
        ))}
      </div>
    </div>

    {/* ── Font weight (prose only) ── */}
    <div>
      <label class="block text-xs mb-2 tracking-wider" style="color: var(--text-muted);">{ui.settings.fontWeightLabel}</label>
      <div class="flex gap-2">
        {Object.entries(fontWeights).map(([key, label]) => (
          <button data-set-fontweight={key}
            class="fontweight-btn flex-1 py-1.5 rounded text-xs transition-all"
            style="border: 1px solid var(--border);">
            {label}
          </button>
        ))}
      </div>
    </div>

    {/* ── Sidenotes global toggle ── */}
    <div>
      <label class="block text-xs mb-2 tracking-wider" style="color: var(--text-muted);">{ui.settings.sidenotesLabel}</label>
      <div class="flex gap-2">
        <button id="sidenotes-show-all"
          class="sidenote-toggle-btn flex-1 py-1.5 rounded text-xs transition-all"
          style="border: 1px solid var(--border);">
          {sidenotes.showAll}
        </button>
        <button id="sidenotes-hide-all"
          class="sidenote-toggle-btn flex-1 py-1.5 rounded text-xs transition-all"
          style="border: 1px solid var(--border);">
          {sidenotes.hideAll}
        </button>
      </div>
    </div>

  </div>
</div>

<script>
  // ── Helpers: always live DOM queries ──

  function getState() { return (window as any).__palimpsestus; }

  function apply(key: string, value: string) {
    const state = getState();
    state[key] = value;
    document.documentElement.setAttribute(`data-${key}`, value);
    try { localStorage.setItem('palimpsestus-settings', JSON.stringify(state)); } catch(e) {}
    updateHighlights();
  }

  function updateHighlights() {
    const panel = document.getElementById('settings-panel');
    if (!panel) return;
    const state = getState();

    panel.querySelectorAll('.theme-btn').forEach((btn) => {
      (btn as HTMLElement).style.borderColor =
        (btn as HTMLElement).dataset.setTheme === state.theme ? 'var(--accent)' : 'transparent';
    });
    panel.querySelectorAll('.fontsize-btn').forEach((btn) => {
      (btn as HTMLElement).style.borderColor =
        (btn as HTMLElement).dataset.setFontsize === state.fontSize ? 'var(--accent)' : 'var(--border)';
    });
    panel.querySelectorAll('.fontweight-btn').forEach((btn) => {
      (btn as HTMLElement).style.borderColor =
        (btn as HTMLElement).dataset.setFontweight === state.fontWeight ? 'var(--accent)' : 'var(--border)';
    });

    const showBtn = document.getElementById('sidenotes-show-all') as HTMLElement;
    const hideBtn = document.getElementById('sidenotes-hide-all') as HTMLElement;
    if (showBtn && hideBtn) {
      showBtn.style.borderColor = state.sidenotesAutoOpen ? 'var(--accent)' : 'var(--border)';
      hideBtn.style.borderColor = !state.sidenotesAutoOpen ? 'var(--accent)' : 'var(--border)';
    }
  }

  // ── Event delegation: bound ONCE on document ──

  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const panel = document.getElementById('settings-panel');
    const toggle = document.getElementById('settings-toggle');

    // Toggle button
    if (target.closest('#settings-toggle')) {
      panel?.classList.toggle('hidden');
      return;
    }

    // Theme buttons
    const themeBtn = target.closest('[data-set-theme]') as HTMLElement;
    if (themeBtn?.dataset.setTheme) {
      apply('theme', themeBtn.dataset.setTheme);
      return;
    }

    // Font size buttons
    const sizeBtn = target.closest('[data-set-fontsize]') as HTMLElement;
    if (sizeBtn?.dataset.setFontsize) {
      apply('fontSize', sizeBtn.dataset.setFontsize);
      return;
    }

    // Font weight buttons
    const weightBtn = target.closest('[data-set-fontweight]') as HTMLElement;
    if (weightBtn?.dataset.setFontweight) {
      apply('fontWeight', weightBtn.dataset.setFontweight);
      return;
    }

    // Sidenotes show all
    if (target.closest('#sidenotes-show-all')) {
      const state = getState();
      state.sidenotesAutoOpen = true;
      document.querySelectorAll('.sidenote-content').forEach(el => el.classList.add('open'));
      document.querySelectorAll('.sidenote-trigger').forEach(el => el.classList.add('active'));
      try { localStorage.setItem('palimpsestus-settings', JSON.stringify(state)); } catch(e) {}
      updateHighlights();
      return;
    }

    // Sidenotes hide all
    if (target.closest('#sidenotes-hide-all')) {
      const state = getState();
      state.sidenotesAutoOpen = false;
      document.querySelectorAll('.sidenote-content').forEach(el => el.classList.remove('open'));
      document.querySelectorAll('.sidenote-trigger').forEach(el => el.classList.remove('active'));
      try { localStorage.setItem('palimpsestus-settings', JSON.stringify(state)); } catch(e) {}
      updateHighlights();
      return;
    }

    // Click outside panel → close
    if (panel && !panel.contains(target) && !target.closest('#settings-toggle')) {
      panel.classList.add('hidden');
    }
  });

  // Initial highlight + refresh after navigation
  updateHighlights();
  document.addEventListener('astro:after-swap', updateHighlights);
</script>
