---
import { ui } from '@/config/site';

const { themes, fontSizes, fontFamilies, sidenotes } = ui.settings;
---

<button id="settings-toggle"
  class="fixed bottom-6 right-6 z-30 w-10 h-10 rounded-full flex items-center justify-center transition-all duration-200 hover:scale-110"
  style="background: var(--bg-surface); color: var(--text-muted); border: 1px solid var(--border);"
  aria-label={ui.settings.label} title={ui.settings.label}>
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
  </svg>
</button>

<div id="settings-panel" class="fixed bottom-20 right-6 z-30 rounded-lg p-5 w-64 hidden"
  style="background: var(--bg-surface); border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
  <div class="space-y-5">

    {/* ── Theme ── */}
    <div>
      <label class="block text-xs mb-2 tracking-wider" style="color: var(--text-muted);">{ui.settings.bgLabel}</label>
      <div class="flex gap-2">
        {Object.entries(themes).map(([key, label]) => (
          <button data-set-theme={key}
            class="theme-btn flex-1 py-1.5 rounded text-xs transition-all"
            style={`border: 2px solid transparent; ${
              key === 'paper' ? 'background:#F4F1EA;color:#2C2C2C;' :
              key === 'white' ? 'background:#FAFAFA;color:#2C2C2C;' :
              'background:#1A1A1A;color:#D4CFC6;'
            }`}>
            {label}
          </button>
        ))}
      </div>
    </div>

    {/* ── Font size ── */}
    <div>
      <label class="block text-xs mb-2 tracking-wider" style="color: var(--text-muted);">{ui.settings.fontSizeLabel}</label>
      <div class="flex gap-2">
        {Object.entries(fontSizes).map(([key, label]) => (
          <button data-set-fontsize={key}
            class="fontsize-btn flex-1 py-1.5 rounded text-xs transition-all"
            style="border: 1px solid var(--border);">
            {label}
          </button>
        ))}
      </div>
    </div>

    {/* ── Font family ── */}
    <div>
      <label class="block text-xs mb-2 tracking-wider" style="color: var(--text-muted);">{ui.settings.fontFamilyLabel}</label>
      <div class="flex gap-2">
        {Object.entries(fontFamilies).map(([key, label]) => (
          <button data-set-fontfamily={key}
            class="fontfamily-btn flex-1 py-1.5 rounded text-xs transition-all"
            style={`border: 1px solid var(--border); font-family: ${
              key === 'kai' ? "'LXGW WenKai', serif" : "'Noto Serif SC', serif"
            };`}>
            {label}
          </button>
        ))}
      </div>
    </div>

    {/* ── Sidenotes global toggle ── */}
    <div>
      <label class="block text-xs mb-2 tracking-wider" style="color: var(--text-muted);">{ui.settings.sidenotesLabel}</label>
      <div class="flex gap-2">
        <button id="sidenotes-show-all"
          class="sidenote-toggle-btn flex-1 py-1.5 rounded text-xs transition-all"
          style="border: 1px solid var(--border);">
          {sidenotes.showAll}
        </button>
        <button id="sidenotes-hide-all"
          class="sidenote-toggle-btn flex-1 py-1.5 rounded text-xs transition-all"
          style="border: 1px solid var(--border);">
          {sidenotes.hideAll}
        </button>
      </div>
    </div>

  </div>
</div>

<script>
  function initSettings() {
    const toggle = document.getElementById('settings-toggle');
    const panel = document.getElementById('settings-panel');
    if (!toggle || !panel) return;

    toggle.addEventListener('click', (e) => {
      e.stopPropagation();
      panel.classList.toggle('hidden');
    });
    document.addEventListener('click', (e) => {
      if (!panel.contains(e.target as Node) && e.target !== toggle) {
        panel.classList.add('hidden');
      }
    });

    const state = (window as any).__palimpsestus;

    function apply(key: string, value: string) {
      state[key] = value;
      document.documentElement.setAttribute(`data-${key}`, value);
      try { localStorage.setItem('palimpsestus-settings', JSON.stringify(state)); } catch(e) {}
      updateHighlights();
    }

    function updateHighlights() {
      panel.querySelectorAll('.theme-btn').forEach((btn) => {
        (btn as HTMLElement).style.borderColor =
          (btn as HTMLElement).dataset.setTheme === state.theme ? 'var(--accent)' : 'transparent';
      });
      panel.querySelectorAll('.fontsize-btn').forEach((btn) => {
        (btn as HTMLElement).style.borderColor =
          (btn as HTMLElement).dataset.setFontsize === state.fontSize ? 'var(--accent)' : 'var(--border)';
      });
      panel.querySelectorAll('.fontfamily-btn').forEach((btn) => {
        (btn as HTMLElement).style.borderColor =
          (btn as HTMLElement).dataset.setFontfamily === state.fontFamily ? 'var(--accent)' : 'var(--border)';
      });

      // Sidenote toggle highlights
      const showBtn = document.getElementById('sidenotes-show-all') as HTMLElement;
      const hideBtn = document.getElementById('sidenotes-hide-all') as HTMLElement;
      if (showBtn && hideBtn) {
        showBtn.style.borderColor = state.sidenotesAutoOpen ? 'var(--accent)' : 'var(--border)';
        hideBtn.style.borderColor = !state.sidenotesAutoOpen ? 'var(--accent)' : 'var(--border)';
      }
    }

    // Theme / font buttons
    panel.querySelectorAll('[data-set-theme]').forEach((btn) => {
      btn.addEventListener('click', () => apply('theme', (btn as HTMLElement).dataset.setTheme!));
    });
    panel.querySelectorAll('[data-set-fontsize]').forEach((btn) => {
      btn.addEventListener('click', () => apply('fontSize', (btn as HTMLElement).dataset.setFontsize!));
    });
    panel.querySelectorAll('[data-set-fontfamily]').forEach((btn) => {
      btn.addEventListener('click', () => apply('fontFamily', (btn as HTMLElement).dataset.setFontfamily!));
    });

    // Sidenote global toggle
    document.getElementById('sidenotes-show-all')?.addEventListener('click', () => {
      state.sidenotesAutoOpen = true;
      document.querySelectorAll('.sidenote-content').forEach(el => el.classList.add('open'));
      document.querySelectorAll('.sidenote-trigger').forEach(el => el.classList.add('active'));
      try { localStorage.setItem('palimpsestus-settings', JSON.stringify(state)); } catch(e) {}
      updateHighlights();
    });

    document.getElementById('sidenotes-hide-all')?.addEventListener('click', () => {
      state.sidenotesAutoOpen = false;
      document.querySelectorAll('.sidenote-content').forEach(el => el.classList.remove('open'));
      document.querySelectorAll('.sidenote-trigger').forEach(el => el.classList.remove('active'));
      try { localStorage.setItem('palimpsestus-settings', JSON.stringify(state)); } catch(e) {}
      updateHighlights();
    });

    updateHighlights();
  }

  initSettings();
  document.addEventListener('astro:after-swap', initSettings);
</script>
