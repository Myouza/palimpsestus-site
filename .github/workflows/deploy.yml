# deploy.yml â€” Trigger server-side build & deploy
#
# Triggers:
#   1. Push to main/preview on this (framework) repo
#   2. repository_dispatch from private content repo
#   3. Manual trigger from GitHub Actions UI (workflow_dispatch)
#
# Branch combinations (always symmetrical):
#   main + main       â†’ production (/var/www/production)
#   preview + preview â†’ staging    (/var/www/staging)

name: Build & Deploy

on:
  push:
    branches: [main, preview]

  repository_dispatch:
    types: [content-update]

  # Manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      branch:
        description: 'Deploy target (main=production, preview=staging)'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - preview

concurrency:
  group: deploy-${{ github.event.inputs.branch || (github.event_name == 'repository_dispatch' && github.event.client_payload.branch) || github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set deployment target
        id: target
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BRANCH="${{ github.event.inputs.branch }}"
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            BRANCH="${{ github.event.client_payload.branch }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi

          echo "content_branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "framework_branch=$BRANCH" >> $GITHUB_OUTPUT

          if [ "$BRANCH" = "main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

          echo "ðŸ“‹ Trigger: ${{ github.event_name }}"
          echo "ðŸ“‹ Branch: $BRANCH"
          echo "ðŸ“‹ Environment: $([ '$BRANCH' = 'main' ] && echo production || echo staging)"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SERVER_SSH_PORT }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "bash /opt/palimpsestus/repos/framework/scripts/server-deploy.sh \
              ${{ steps.target.outputs.content_branch }} \
              ${{ steps.target.outputs.framework_branch }}"

      - name: Deployment summary
        if: always()
        run: |
          echo "### ðŸš€ Deployed to ${{ steps.target.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Framework: \`${{ steps.target.outputs.framework_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Content: \`${{ steps.target.outputs.content_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
