# deploy.yml â€” Build & Deploy Palimpsestus
#
# Triggers:
#   1. Push to main/preview (framework changes)
#   2. repository_dispatch from private content repo
#
# Logic:
#   - Framework push: uses pushed branch for both framework & content
#   - Content dispatch: uses main for framework, payload.branch for content
#   - main â†’ deploy to production
#   - preview â†’ deploy to staging

name: Build & Deploy

on:
  push:
    branches: [main, preview]
  repository_dispatch:
    types: [content-update]

concurrency:
  group: deploy-${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch || github.ref_name }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ Determine deployment target â”€â”€
      - name: Set deployment target
        id: target
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            BRANCH="${{ github.event.client_payload.branch }}"
            # Content dispatch: always use main for framework code
            FRAMEWORK_REF="main"
          else
            BRANCH="${{ github.ref_name }}"
            # Framework push: use the branch that was pushed
            FRAMEWORK_REF="${{ github.ref_name }}"
          fi

          if [ "$BRANCH" = "main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "deploy_path=/var/www/production" >> $GITHUB_OUTPUT
            echo "content_ref=main" >> $GITHUB_OUTPUT
          elif [ "$BRANCH" = "preview" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "deploy_path=/var/www/staging" >> $GITHUB_OUTPUT
            echo "content_ref=preview" >> $GITHUB_OUTPUT
          else
            echo "Unknown branch: $BRANCH"
            exit 1
          fi

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "framework_ref=$FRAMEWORK_REF" >> $GITHUB_OUTPUT

      # â”€â”€ Checkout framework â”€â”€
      - name: Checkout framework
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.target.outputs.framework_ref }}

      # â”€â”€ Checkout content (private repo) â”€â”€
      - name: Checkout content
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.CONTENT_REPO }}
          ref: ${{ steps.target.outputs.content_ref }}
          ssh-key: ${{ secrets.CONTENT_DEPLOY_KEY }}
          path: _content

      # â”€â”€ Merge content into framework â”€â”€
      - name: Copy content into src/content/novel
        run: |
          rm -rf src/content/novel
          mkdir -p src/content/novel
          cp -r _content/[0-9]*/ src/content/novel/ 2>/dev/null || true
          find src/content/novel -name 'meta.yaml' -delete
          if [ -d "_content/assets" ]; then
            cp -r _content/assets/ public/assets/
          fi
          echo "Content files:"
          find src/content/novel -name '*.mdx' | sort

      # â”€â”€ Setup Node.js â”€â”€
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # â”€â”€ Install & Build â”€â”€
      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      # â”€â”€ Deploy via rsync â”€â”€
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SERVER_SSH_PORT }}" \
            dist/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ steps.target.outputs.deploy_path }}/

      # â”€â”€ Summary â”€â”€
      - name: Deployment summary
        run: |
          echo "### ðŸš€ Deployed to ${{ steps.target.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Framework: \`${{ steps.target.outputs.framework_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Content: \`${{ steps.target.outputs.content_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Target: \`${{ steps.target.outputs.deploy_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
