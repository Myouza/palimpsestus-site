# deploy.yml â€” Trigger server-side build & deploy
#
# Triggers:
#   1. Push to main/preview (framework changes)
#   2. repository_dispatch from private content repo
#
# Logic:
#   - Determines content_branch and framework_branch
#   - SSHs into the server and runs server-deploy.sh
#   - Server handles: git pull, font subsetting, build, deploy
#
# Required secrets:
#   SERVER_HOST, SERVER_SSH_PORT, SERVER_USER, SERVER_SSH_KEY
#   CONTENT_REPO, CONTENT_DEPLOY_KEY, FRAMEWORK_DISPATCH_TOKEN (content repo)

name: Build & Deploy

on:
  push:
    branches: [main, preview]
  repository_dispatch:
    types: [content-update]

concurrency:
  group: deploy-${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch || github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ Determine branches â”€â”€
      - name: Set deployment target
        id: target
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            CONTENT_BRANCH="${{ github.event.client_payload.branch }}"
            FRAMEWORK_BRANCH="main"
          else
            CONTENT_BRANCH="${{ github.ref_name }}"
            FRAMEWORK_BRANCH="${{ github.ref_name }}"
          fi

          echo "content_branch=$CONTENT_BRANCH" >> $GITHUB_OUTPUT
          echo "framework_branch=$FRAMEWORK_BRANCH" >> $GITHUB_OUTPUT

          if [ "$CONTENT_BRANCH" = "main" ] && [ "$FRAMEWORK_BRANCH" = "main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      # â”€â”€ SSH to server and run deploy â”€â”€
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SERVER_SSH_PORT }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "bash /opt/palimpsestus/repos/framework/scripts/server-deploy.sh \
              ${{ steps.target.outputs.content_branch }} \
              ${{ steps.target.outputs.framework_branch }}"

      # â”€â”€ Summary â”€â”€
      - name: Deployment summary
        run: |
          echo "### ðŸš€ Deployed to ${{ steps.target.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Framework: \`${{ steps.target.outputs.framework_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Content: \`${{ steps.target.outputs.content_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
